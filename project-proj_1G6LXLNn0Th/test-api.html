<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>APIæµ‹è¯•é¡µé¢</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        .test-section {
            border: 1px solid #ccc;
            margin: 20px 0;
            padding: 20px;
            border-radius: 8px;
        }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
        }
        .success { background-color: #d4edda; color: #155724; }
        .error { background-color: #f8d7da; color: #721c24; }
        .info { background-color: #d1ecf1; color: #0c5460; }
        button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover { background-color: #0056b3; }
        textarea {
            width: 100%;
            height: 100px;
            margin: 10px 0;
        }
        input[type="file"] {
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <h1>ğŸ§ª APIåŠŸèƒ½æµ‹è¯•</h1>
    
    <!-- 1. å¥åº·æ£€æŸ¥æµ‹è¯• -->
    <div class="test-section">
        <h2>1. åç«¯å¥åº·æ£€æŸ¥</h2>
        <button onclick="testHealth()">æµ‹è¯•å¥åº·æ£€æŸ¥</button>
        <div id="health-status"></div>
    </div>

    <!-- 2. å›¾ç‰‡ä¸Šä¼ å’Œåˆ†ææµ‹è¯• -->
    <div class="test-section">
        <h2>2. å›¾ç‰‡ä¸Šä¼ å’ŒAIåˆ†ææµ‹è¯•</h2>
        <p>é€‰æ‹©ä¸€ä¸ªå›¾ç‰‡æ–‡ä»¶è¿›è¡Œä¸Šä¼ å’ŒAIåˆ†æï¼š</p>
        <input type="file" id="imageFile" accept="image/*">
        <br>
        <button onclick="testImageUpload()">æµ‹è¯•å›¾ç‰‡ä¸Šä¼ åˆ†æ</button>
        <div id="image-status"></div>
        <textarea id="image-result" placeholder="åˆ†æç»“æœå°†æ˜¾ç¤ºåœ¨è¿™é‡Œ..." readonly></textarea>
    </div>

    <!-- 3. WebSocketè¿æ¥æµ‹è¯• -->
    <div class="test-section">
        <h2>3. WebSocketå®æ—¶è¯­éŸ³è¿æ¥æµ‹è¯•</h2>
        <button onclick="testWebSocket()">æµ‹è¯•WebSocketè¿æ¥</button>
        <button onclick="disconnectWebSocket()">æ–­å¼€è¿æ¥</button>
        <div id="websocket-status"></div>
        <textarea id="websocket-log" placeholder="WebSocketæ—¥å¿—å°†æ˜¾ç¤ºåœ¨è¿™é‡Œ..." readonly></textarea>
    </div>

    <script>
        let ws = null;

        // æ˜¾ç¤ºçŠ¶æ€æ¶ˆæ¯
        function showStatus(elementId, message, type = 'info') {
            const element = document.getElementById(elementId);
            element.innerHTML = '<div class="status ' + type + '">' + message + '</div>';
        }

        // 1. æµ‹è¯•å¥åº·æ£€æŸ¥
        async function testHealth() {
            showStatus('health-status', 'æ­£åœ¨æµ‹è¯•å¥åº·æ£€æŸ¥...', 'info');
            
            try {
                const response = await fetch('http://localhost:3000/health');
                const data = await response.json();
                
                if (response.ok) {
                    showStatus('health-status', 'âœ… å¥åº·æ£€æŸ¥æˆåŠŸ: ' + JSON.stringify(data), 'success');
                } else {
                    showStatus('health-status', 'âŒ å¥åº·æ£€æŸ¥å¤±è´¥: ' + response.status, 'error');
                }
            } catch (error) {
                showStatus('health-status', 'âŒ è¿æ¥å¤±è´¥: ' + error.message, 'error');
            }
        }

        // 2. æµ‹è¯•å›¾ç‰‡ä¸Šä¼ 
        async function testImageUpload() {
            const fileInput = document.getElementById('imageFile');
            const file = fileInput.files[0];
            
            if (!file) {
                showStatus('image-status', 'âŒ è¯·é€‰æ‹©ä¸€ä¸ªå›¾ç‰‡æ–‡ä»¶', 'error');
                return;
            }

            showStatus('image-status', 'æ­£åœ¨ä¸Šä¼ å’Œåˆ†æå›¾ç‰‡...', 'info');
            
            try {
                const formData = new FormData();
                formData.append('image', file);
                formData.append('sessionId', 'test-' + Date.now());

                const response = await fetch('http://localhost:3000/api/upload-image', {
                    method: 'POST',
                    body: formData
                });

                const data = await response.json();
                
                if (response.ok) {
                    showStatus('image-status', 'âœ… å›¾ç‰‡ä¸Šä¼ å’Œåˆ†ææˆåŠŸ', 'success');
                    document.getElementById('image-result').value = JSON.stringify(data, null, 2);
                } else {
                    showStatus('image-status', 'âŒ ä¸Šä¼ å¤±è´¥: ' + (data.error || response.statusText), 'error');
                    document.getElementById('image-result').value = JSON.stringify(data, null, 2);
                }
            } catch (error) {
                showStatus('image-status', 'âŒ ä¸Šä¼ é”™è¯¯: ' + error.message, 'error');
            }
        }

        // 3. æµ‹è¯•WebSocketè¿æ¥
        function testWebSocket() {
            if (ws && ws.readyState === WebSocket.OPEN) {
                showStatus('websocket-status', 'âš ï¸ WebSocketå·²ç»è¿æ¥', 'info');
                return;
            }

            showStatus('websocket-status', 'æ­£åœ¨è¿æ¥WebSocket...', 'info');
            
            try {
                ws = new WebSocket('ws://localhost:8082?sessionId=test&model=step-1o-audio');
                
                ws.onopen = function(event) {
                    showStatus('websocket-status', 'âœ… WebSocketè¿æ¥æˆåŠŸ', 'success');
                    addWebSocketLog('è¿æ¥å·²å»ºç«‹');
                    
                    // å‘é€ä¼šè¯åˆå§‹åŒ–æ¶ˆæ¯ï¼ˆä½¿ç”¨æ­£ç¡®çš„è¯­éŸ³ï¼‰
                    const sessionUpdate = {
                        type: 'session.update',
                        session: {
                            modalities: ['text', 'audio'],
                            instructions: 'ä½ æ˜¯ä¸€ä¸ªå‹å–„çš„AIåŠ©æ‰‹ï¼Œæ­£åœ¨å’Œå„¿ç«¥å¯¹è¯',
                            voice: 'jingdiannvsheng'
                        }
                    };
                    ws.send(JSON.stringify(sessionUpdate));
                    addWebSocketLog('å·²å‘é€ä¼šè¯åˆå§‹åŒ–æ¶ˆæ¯');
                };
                
                ws.onmessage = function(event) {
                    addWebSocketLog('æ”¶åˆ°æ¶ˆæ¯: ' + event.data);
                };
                
                ws.onclose = function(event) {
                    showStatus('websocket-status', 'ğŸ”Œ WebSocketè¿æ¥å·²å…³é—­', 'info');
                    addWebSocketLog('è¿æ¥å…³é—­: code=' + event.code + ', reason=' + event.reason);
                };
                
                ws.onerror = function(error) {
                    showStatus('websocket-status', 'âŒ WebSocketè¿æ¥é”™è¯¯', 'error');
                    addWebSocketLog('è¿æ¥é”™è¯¯: ' + error);
                };
            } catch (error) {
                showStatus('websocket-status', 'âŒ WebSocketåˆ›å»ºå¤±è´¥: ' + error.message, 'error');
            }
        }

        function disconnectWebSocket() {
            if (ws) {
                ws.close();
                ws = null;
                showStatus('websocket-status', 'ğŸ”Œ å·²ä¸»åŠ¨æ–­å¼€WebSocketè¿æ¥', 'info');
            }
        }

        function addWebSocketLog(message) {
            const log = document.getElementById('websocket-log');
            const timestamp = new Date().toLocaleTimeString();
            log.value += '[' + timestamp + '] ' + message + '\n';
            log.scrollTop = log.scrollHeight;
        }

        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨æµ‹è¯•å¥åº·æ£€æŸ¥
        window.addEventListener('load', function() {
            testHealth();
        });
    </script>
</body>
</html>
